<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>HTML2Canvas PHP Proxy</title>
</head>
<body>
    <?php
    /*
     * html2canvas-php-proxy 1.1.4
     *
     * Copyright (c) 2020 Guilherme Nascimento (brcontainer@yahoo.com.br)
     *
     * Released under the MIT license
     */

    // Turn off errors because the script already own uses "error_get_last"
    ini_set('display_errors', 'Off');

    // Setup
    define('H2CP_PATH', 'cache');                   // Relative folder where the images are saved
    define('H2CP_PERMISSION', 0666);                // use 644 or 666 for remove execution for prevent sploits
    define('H2CP_CACHE', 60 * 5 * 1000);            // Limit access-control and cache, define 0/false/null/-1 to prevent cache
    define('H2CP_TIMEOUT', 20);                     // Timeout from load Socket
    define('H2CP_MAX_LOOP', 10);                    // Configure loop limit for redirects (location header)
    define('H2CP_DATAURI', false);                  // Enable use of "data URI scheme"
    define('H2CP_PREFER_CURL', true);               // Enable curl if avaliable or disable
    define('H2CP_SECPREFIX', 'h2cp_');              // Prefix temp filename
    define('H2CP_ALLOWED_DOMAINS', '*');            // * allow all domains, *.site.com for sub-domains, or fixed domains use `define('H2CP_ALLOWED_DOMAINS', 'site.com,www.site.com' )
    define('H2CP_ALLOWED_PORTS', '80,443');         // Allowed ports
    define('H2CP_ALTERNATIVE', 'console.log');      // callback alternative

    /*
     * Set false for disable SSL check
     * Set true for enable SSL check, require config `curl.cainfo=/path/to/cacert.pem` in php.ini
     * Set path (string) if need config CAINFO manually like this define('H2CP_SSL_VERIFY_PEER', '/path/to/cacert.pem');
     */
    define('H2CP_SSL_VERIFY_PEER', false);

    // Constants (don't change)
    define('H2CP_EOL', chr(10));
    define('H2CP_GMDATECACHE', gmdate('D, d M Y H:i:s'));
    define('H2CP_INIT_EXEC', time());

    if (empty($_GET['callback'])) {
        $callback = false;
    } else {
        $callback = $_GET['callback'];
    }

    /*
    If execution has reached the time limit prevents page goes blank (off errors)
    or generate an error in PHP, which does not work with the DEBUG (from html2canvas.js)
    */
    $maxExec = (int) ini_get('max_execution_time');
    define('H2CP_MAX_EXEC', $maxExec < 1 ? 0 : ($maxExec - 5));//reduces 5 seconds to ensure the execution of the DEBUG

    $http_port = 0;

    $tmp = null;//tmp var usage
    $response = array();

    // The rest of the PHP script goes here...
    // Functions: asciiToInline, supportSSL, removeOldFiles, checkContentType, JsonEncodeString, setHeaders, relativeToAbsolute, isHttpUrl, isAllowedUrl, createFolder, createTmpFile, curlDownloadSource, downloadSource

    // Additional PHP code
    if (empty($_SERVER['HTTP_HOST'])) {
        $response = array('error' => 'The client did not send the Host header');
    } elseif (empty($_SERVER['SERVER_PORT'])) {
        $response = array('error' => 'The Server-proxy did not send the PORT (configure PHP)');
    } elseif (H2CP_MAX_EXEC < 10) {
        $response = array('error' => 'Execution time is less 15 seconds, configure this with ini_set/set_time_limit or "php.ini" (if safe_mode is enabled), recommended time is 30 seconds or more');
    } elseif (H2CP_MAX_EXEC <= H2CP_TIMEOUT) {
        $response = array('error' => 'The execution time is not configured enough to TIMEOUT in SOCKET, configure this with ini_set/set_time_limit or "php.ini" (if safe_mode is enabled), recommended that the "max_execution_time =;" be a minimum of 5 seconds longer or reduce the TIMEOUT in "define(\'H2CP_TIMEOUT\', ' . H2CP_TIMEOUT . ');"');
    } elseif (empty($_GET['url'])) {
        $response = array('error' => 'No such parameter "url"');
    } elseif (isHttpUrl($_GET['url']) === false) {
        $response = array('error' => 'Only http scheme and https scheme are allowed');
    } elseif (isAllowedUrl($_GET['url'], $message) === false) {
        $response = array('error' => $message);
    } elseif (createFolder() === false) {
        $err = error_get_last();
        $response = array('error' => 'Can not create directory'. (
            $err !== null && empty($err['message']) ? '' : (': ' . $err['message'])
        ));
        $err = null;
    } else {
        $http_port = (int) $_SERVER['SERVER_PORT'];

        $tmp = createTmpFile($_GET['url'], false);

        if ($tmp === false) {
            $err = error_get_last();
            $response = array('error' => 'Can not create file'. (
                $err !== null && empty($err['message']) ? '' : (': ' . $err['message'])
            ));
            $err = null;
        } elseif (H2CP_PREFER_CURL && function_exists('curl_init')) {
            $response = curlDownloadSource($_GET['url'], $tmp['source']);
        } else {
            $response = downloadSource($_GET['url'], $tmp['source'], 0);
        }

        if ($tmp) fclose($tmp['source']);
    }

    //set mime-type
    header('Content-Type: application/javascript');

    if (is_array($response) && false === empty($response['mime'])) {
        clearstatcache();

        if (false === file_exists($tmp['location'])) {
            $response = array('error' => 'Request was downloaded, but file can not be found, try again');
        } elseif (filesize($tmp['location']) < 1) {
            $response = array('error' => 'Request was downloaded, but there was some problem and now the file is empty, try again');
        } else {
            $extension = str_replace(array('image/', 'text/', 'application/'), '', $response['mime']);
            $extension = str_replace(array('windows-bmp', 'ms-bmp'), 'bmp', $extension);
            $extension = str_replace(array('svg+xml', 'svg-xml'), 'svg', $extension);
            $extension = str_replace('xhtml+xml', 'xhtml', $extension);
            $extension = str_replace('jpeg', 'jpg', $extension);

            $locationFile = preg_replace('#[.][0-9_]+$#', '.' . $extension, $tmp['location']);

            if (file_exists($locationFile)) {
                unlink($locationFile);
            }

            if (rename($tmp['location'], $locationFile)) {
                //set cache
                setHeaders(false);

                removeOldFiles();

                $mime = $response['mime'];

                if ($response['encode'] !== null) {
                    $mime .= ';charset=' . JsonEncodeString($response['encode'], true);
                }

                if ($callback === false) {
                    header('Content-Type: ' . $mime);
                    echo file_get_contents($locationFile);
                } elseif (H2CP_DATAURI) {
                    $tmp = $response = null;

                    header('Content-Type: application/javascript');

                    if (strpos($mime, 'image/svg') !== 0 && strpos($mime, 'image/') === 0) {
                        echo $callback, '("data:', $mime, ';base64,',
                            base64_encode(
                                file_get_contents($locationFile)
                            ),
                        '");';
                    } else {
                        echo $callback, '("data:', $mime, ',',
                            asciiToInline(file_get_contents($locationFile)),
                        '");';
                    }
                } else {
                    $tmp = $response = null;

                    header('Content-Type: application/javascript');

                    $dir_name = dirname($_SERVER['SCRIPT_NAME']);

                    if ($dir_name === '\/' || $dir_name === '\\') {
                        $dir_name = '';
                    }

                    echo $callback, '(',
                        JsonEncodeString(
                            ($http_port === 443 ? 'https://' : 'http://') .
                            preg_replace('#[:]\\d+$#', '', $_SERVER['HTTP_HOST']) .
                            ($http_port === 80 || $http_port === 443 ? '' : (
                                ':' . $_SERVER['SERVER_PORT']
                            )) .
                            $dir_name. '/' .
                            $locationFile
                        ),
                    ');';
                }
                exit;
            } else {
                $response = array('error' => 'Failed to rename the temporary file');
            }
        }
    }

    if (is_array($tmp) && isset($tmp['location']) && file_exists($tmp['location'])) {
        // Remove temporary file if an error occurred
        unlink($tmp['location']);
    }

    setHeaders(true); // no-cache

    header('Content-Type: application/javascript');

    removeOldFiles();

    if ($callback === false) {
        $callback = H2CP_ALTERNATIVE;
    }

    echo $callback, '(',
        JsonEncodeString('error: html2canvas-proxy-php: ' . $response['error']),
    ');';
    ?>
</body>
</html>
